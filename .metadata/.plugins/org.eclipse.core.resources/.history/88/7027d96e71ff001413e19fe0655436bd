'''
Created on May 20, 2015

@author: yhuang
'''
import ipaddress
import SubnetTree
import sys
import fileinput
import os
import linecache

from _functools import reduce

    
if len( sys.argv) != 3 :
    print("Usage: \n"
          "     convert <source file> <destfile>\n")
    sys.exit( )

print("ok")

namelst = []
routelst = []
accesslst = []

cGType = ""
cGName = ""

netGLst = []
serviceGLst = []
protocolLst = []

for line in fileinput.input(sys.argv[1]):
    line = line.strip()
    if line.startswith("name ") :
        namelst.append(line)
    elif line.startswith("route "):
        routelst.append(line)
    elif line.startswith("access-list "):
        accesslst.append(line)
    elif line.startswith("object-group "):
        words = line.split()
        cGType = words[1]
        cGName = words[2] 
        if cGType == "network":
            netGLst.append( (cGName, []))
        elif cGType == "service":
            serviceGLst.append( (cGName, []))
        elif cGType == "protocol":
            protocolLst.append( (cGName, []))
    elif line.startswith("description"):
        pass
    elif line.startswith("network-object") and cGType == "network":
        if netGLst[-1][0] == cGName:
            netGLst[-1][1].append( line)
    elif line.startswith("port-objec") and cGType == "service":
        if serviceGLst[-1][0] == cGName:
            serviceGLst[-1][1].append(line)
    elif line.startswith("protocol-object") and cGType == "protocol":
        if protocolLst[-1][0] == cGName:
            protocolLst[-1][1].append(line)
    elif line.startswith("group-object"):
        if cGType == "network" and netGLst[-1][0] == cGName:
            netGLst[-1][1].append( line)
        elif cGType == "service" and serviceGLst[-1][0] == cGName:
            serviceGLst[-1][1].append(line)
        elif cGType == "protocol" and protocolLst[-1][0] == cGName:
            protocolLst[-1][1].append(line)


#print( netGLst["Direct_Access_to_Web_Servers"])
for n in netGLst:
    print(n)

## Load all names
names = { k: v for d in list( map( lambda x: {x.split()[2]: x.split()[1]}, namelst ) ) for k, v in d.items() }
 
## Load all routes
def addRouteByNames(routelst, names):
    def addRoute(rs, line):
        words = line.split()
        if words[2] in names:
            rs[ipaddress.IPv4Network(names[words[2]] + "/" + words[3]).compressed] = words[1]
        else:
            rs[ipaddress.IPv4Network(words[2] + "/" + words[3]).compressed] = words[1]
     
        return rs
 
    return reduce( addRoute, routelst, SubnetTree.SubnetTree())
 
 
routes = addRouteByNames(routelst, names)
 
try:
    print(routes["137.172.26.140"])
except KeyError as err:
    print("Error: %s not found" % err)
     
## Load all network object groups
for t in netGLst:
    gn = t[0]
    ip = ""
    for line in t[1]:
        words = line.split()
        if words[0] == "network-object":
            if words[1] == "host":
                ip = names[words[2]]
            else:
                ip = ipaddress.IPv4Network( names[words[1] ] + "/" + words[2]).compressed
        elif word[0] == "object-group":
            pass
        pass
     
    






